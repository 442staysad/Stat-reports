@model List<Stat_reports.ViewModels.PendingTemplateViewModel>

@{

    ViewData["Title"] = "Отчеты в работе";
    bool isAdminOrHeadOffice = true;
    int? branchId = HttpContextAccessor.HttpContext?.Session?.GetInt32("BranchId");
}

@section Styles {
    <style>
        body {
            background: linear-gradient(to right, #003366, #0066cc);
            color: white;
            min-height: 100vh;
            padding-top: 40px;
            padding-bottom: 40px;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 15px;
            max-width: 1200px;
            margin: auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
        }

        .table thead {
            background-color: #002244 !important;
            color: white;
        }

        .table tbody {
            background-color: rgba(255, 255, 255, 0.85);
            color: #000;
        }

        .badge {
            font-size: 0.9rem;
        }

        .btn-primary, .btn-success, .btn-danger {
            margin-right: 5px;
        }

        .nav-tabs .nav-link {
            color: white;
        }

            .nav-tabs .nav-link.active {
                background-color: #ffcc00;
                color: #003366;
                border: none;
            }
    </style>
}

<div class="main-container">
    <h2 class="text-center mb-4">@ViewData["Title"]</h2>

    @if (isAdminOrHeadOffice)
    {
        <ul class="nav nav-tabs" id="branchTabs" role="tablist">
            @foreach (var branchName in Model.Select(m => m.BranchName).Distinct())
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(branchName == Model.First().BranchName ? "active" : "")"
                            id="tab-@branchName"
                            data-bs-toggle="tab"
                            data-bs-target="#branch-@branchName"
                            type="button"
                            role="tab"
                            aria-controls="branch-@branchName"
                            aria-selected="@(branchName == Model.First().BranchName)">
                        @branchName
                    </button>
                </li>
            }
        </ul>

        <div class="tab-content mt-3" id="branchTabsContent">
            @foreach (var branchGroup in Model.GroupBy(m => m.BranchName))
            {
                var branchActive = branchGroup.Key == Model.First().BranchName ? "show active" : "";
                <div class="tab-pane fade @branchActive" id="branch-@branchGroup.Key" role="tabpanel">
                    <table class="table table-hover table-bordered">
                        <thead>
                            <tr>
                                <th>Отчет</th>
                                <th>Срок сдачи</th>
                                <th>Статус</th>
                                <th>Примечание</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in branchGroup)
                            {
                                <tr>
                                    <td>@item.TemplateName</td>
                                    <td>@item.Deadline.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        @if (item.Status == "InProgress")
                                        {
                                            <span class="badge bg-secondary">В работе</span>
                                        }
                                        else if (item.Status == "NeedsCorrection")
                                        {
                                            <span class="badge bg-warning text-dark">Необходима корректировка</span>
                                        }
                                        else if (item.Status == "Reviewed")
                                        {
                                            <span class="badge bg-success">Принято</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-light text-dark">Черновик</span>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.Comment))
                                        {
                                            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#commentModal-@item.ReportId">
                                                Комментарий
                                            </button>

                                            <!-- Модальное окно -->
                                            <div class="modal fade" id="commentModal-@item.ReportId" tabindex="-1" aria-labelledby="commentModalLabel-@item.ReportId" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="commentModalLabel-@item.ReportId">Комментарий</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            @item.Comment
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.Status == "Draft" || item.Status == "NeedsCorrection")
                                        {
                                            <form asp-action="ReloadReport" asp-controller="ReportMvc" method="post" enctype="multipart/form-data" class="d-inline-block">
                                                <input type="hidden" name="reportId" value="@item.ReportId" />
                                                <input type="file" name="file" class="form-control form-control-sm mb-2" required />
                                                <button type="submit" class="btn btn-sm btn-success">
                                                    <i class="bi bi-arrow-repeat"></i> Перезагрузить
                                                </button>
                                            </form>
                                            <a href="@Url.Action("Delete", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Удалить
                                            </a>
                                            <a asp-action="PreviewExcel" asp-route-reportid="@item.ReportId" asp-route-deadlinetId="@item.DeadlineId" class="btn btn-sm btn-primary">
                                                Просмотр
                                            </a>
                                        }
                                        else if (item.Status == "InProgress")
                                        {
                                            <form asp-action="UploadReport" asp-controller="ReportMvc" method="post" enctype="multipart/form-data" class="d-inline-block">
                                                <input type="hidden" name="templateId" value="@item.TemplateId" />
                                                <input type="file" name="file" class="form-control form-control-sm mb-2" required />
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-upload"></i> Загрузить
                                                </button>
                                            </form>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else
    {
        <table class="table table-hover table-bordered mt-3">
            <thead>
                <tr>
                    <th>Отчет</th>
                    <th>Срок сдачи</th>
                    <th>Статус</th>
                    <th>Примечание</th>
                    <th class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Where(m => m.BranchId == branchId))
                {
                    <tr>
                        <td>@item.TemplateName</td>
                        <td>@item.Deadline.ToString("dd.MM.yyyy")</td>
                        <td>
                            @if (item.Status == "InProgress")
                            {
                                <span class="badge bg-secondary">В работе</span>
                            }
                            else if (item.Status == "NeedsCorrection")
                            {
                                <span class="badge bg-warning text-dark">Необходима корректировка</span>
                            }
                            else if (item.Status == "Reviewed")
                            {
                                <span class="badge bg-success">Принято</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark">Черновик</span>
                            }
                        </td>
                        <td>@item.Comment</td>
                        <td class="text-center">
                            @if (item.Status == "Draft" || item.Status == "NeedsCorrection")
                            {

                                    <a href="@Url.Action("Reload", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-success">
                                        <i class="bi bi-arrow-repeat"></i> Перезагрузить
                                    </a>
                                    <a href="@Url.Action("Delete", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-danger">
                                        <i class="bi bi-trash"></i> Удалить
                                    </a>
                                <a asp-action="PreviewExcel" asp-route-reportid="@item.ReportId" asp-route-deadlinetId="@item.DeadlineId" class="btn btn-sm btn-primary">
                                    Просмотр
                                </a>
                            }
                            else if (item.Status == "InProgress")
                            {
                                <form asp-action="UploadReport" asp-controller="ReportMvc" method="post" enctype="multipart/form-data" class="d-inline-block">
                                    <input type="hidden" name="templateId" value="@item.TemplateId" />
                                    <input type="file" name="file" class="form-control form-control-sm mb-2" required />
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="bi bi-upload"></i> Загрузить
                                    </button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>
