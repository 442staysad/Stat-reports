@model List<Stat_reports.ViewModels.PendingTemplateViewModel>
@{
    ViewData["Title"] = "Отчеты в работе";
    bool isAdminOrHeadOffice = true;
    int? branchId = HttpContextAccessor.HttpContext?.Session?.GetInt32("BranchId");
}

<div class="container mt-4">
    <h2 class="mb-4">@ViewData["Title"]</h2>

    @if (isAdminOrHeadOffice)
    {
        <ul class="nav nav-tabs" id="branchTabs" role="tablist">
            @foreach (var branch in Model.Select(m => m.BranchId).Distinct())
            {
                <li class="nav-item" role="presentation">
                    <button class="nav-link @(branch == Model.First().BranchId ? "active" : "")" id="tab-@branch" data-bs-toggle="tab" data-bs-target="#branch-@branch" type="button" role="tab" aria-controls="branch-@branch" aria-selected="@(branch == Model.First().BranchId)">
                        Branch @branch
                    </button>
                </li>
            }
        </ul>
        <div class="tab-content" id="branchTabsContent">
            @foreach (var branch in Model.Select(m => m.BranchId).Distinct())
            {
                <div class="tab-pane fade @(branch == Model.First().BranchId ? "show active" : "")" id="branch-@branch" role="tabpanel" aria-labelledby="tab-@branch">
                    @* Display deadlines for the branch *@
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Отчет</th>
                                <th>Срок сдачи</th>
                                <th>Статус</th>
                                <th>Примечание</th>
                                <th class="text-center">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Where(m => m.BranchId == branch))
                            {
                                <tr>
                                    <td>@item.TemplateName</td>
                                    <td>@item.Deadline.ToString("dd.MM.yyyy")</td>
                                    <td>
                                        @if (item.Status == "InProgress")
                                        {
                                            <span class="badge bg-secondary">В работе</span>
                                        }
                                        else if (item.Status == "NeedsCorrection")
                                        {
                                            <span class="badge bg-warning">Необходима корректировка</span>
                                        }
                                        else if (item.Status == "Reviewed")
                                        {
                                            <span class="badge bg-success">Принято</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">Черновик</span>
                                        }
                                    </td>
                                    <td>@item.Comment</td>
                                    <td class="text-center">
                                        @if (item.Status == "InProgress" || item.Status == "NeedsCorrection")
                                        {
                                            <form asp-action="UploadReport" asp-controller="ReportMvc" method="post" enctype="multipart/form-data">
                                                <input type="hidden" name="templateId" value="@item.TemplateId" />
                                                <input type="file" name="file" class="form-control form-control-sm mb-2" required />
                                                <button type="submit" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-upload"></i> Загрузить
                                                </button>
                                            </form>
                                            
                                        }
                                        else if (item.Status == "NeedsCorrection")
                                        {
                                            <a href="@Url.Action("Reload", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-success">
                                                <i class="bi bi-arrow-repeat"></i> Перезагрузить
                                            </a>
                                            <a href="@Url.Action("Delete", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Удалить
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-action="PreviewExcel" asp-route-reportid="@item.ReportId" asp-route-deadlinetId="@item.DeadlineId" class="btn btn-sm btn-primary">Просмотр</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    }
    else
    {
        @* Display deadlines for the branch user *@
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Отчет</th>
                    <th>Срок сдачи</th>
                    <th>Статус</th>
                    <th>Примечание</th>
                    <th class="text-center">Действия</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Where(m => m.BranchId == branchId))
                {
                    <tr>
                        <td>@item.TemplateName</td>
                        <td>@item.Deadline.ToString("dd.MM.yyyy")</td>
                        <td>
                            @if (item.Status == "InProgress")
                            {
                                <span class="badge bg-secondary">В работе</span>
                            }
                            else if (item.Status == "NeedsCorrection")
                            {
                                <span class="badge bg-warning">Необходима корректировка</span>
                            }
                            else if (item.Status == "Reviewed")
                            {
                                <span class="badge bg-success">Принято</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Черновик</span>
                            }
                        </td>
                        <td>@item.Comment</td>
                        <td class="text-center">
                            @if (item.Status == "Draft" )
                            {
                                <form asp-action="UploadReport" asp-controller="ReportMvc" method="post" enctype="multipart/form-data">
                                    <input type="hidden" name="templateId" value="@item.TemplateId" />
                                    <input type="file" name="file" class="form-control form-control-sm mb-2" required />
                                    <button type="submit" class="btn btn-sm btn-primary">
                                        <i class="bi bi-upload"></i> Загрузить
                                    </button>
                                </form>

                            }
                            else if (item.Status == "NeedsCorrection")
                            {
                                <a href="@Url.Action("Reload", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-success">
                                    <i class="bi bi-arrow-repeat"></i> Перезагрузить
                                </a>
                                <a href="@Url.Action("Delete", "ReportMvc", new { reportId = item.ReportId })" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Удалить
                                </a>

                                <a asp-action="PreviewExcel" asp-route-reportid="@item.ReportId" asp-route-deadlinetId="@item.DeadlineId" class="btn btn-sm btn-primary">Просмотр</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

