@model Stat_reports.ViewModels.ExcelPreviewViewModel
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor

@{
    var role = User.Claims.FirstOrDefault(c => c.Type == System.Security.Claims.ClaimTypes.Role)?.Value;
    bool isAdminOrHeadOffice = true;
    int? branchId = HttpContextAccessor.HttpContext?.Session?.GetInt32("BranchId");
}

@section Styles {
    <link rel="stylesheet" href="~/css/previewExcel.css" />
}

<div class="container-xl">
    <div class="header">
        <h2 class="mb-3">Просмотр отчета: <strong>@Model.ReportName</strong></h2>
    </div>

    @if (!Model.IsArchive && (Model.ReportType == role || User.IsInRole("Admin")))
    {
        <div class="action-section">
            <h4 class="mb-3">Действия с отчетом</h4>
            <form asp-action="AddComment" method="post" class="mb-4">
                <input type="hidden" name="deadlineId" id="deadlineId" value="@Model.DeadlineId" />
                <input type="hidden" name="reportId" id="reportId" value="@Model.ReportId" />
                <div class="mb-3">
                    <label for="comment" class="form-label">Комментарий</label>
                    <textarea class="form-control" id="comment" name="comment" rows="3"
                              placeholder="Введите ваш комментарий...">@Model.Comment</textarea>
                </div>
                <button type="submit" class="btn btn-primary">
                    Сохранить комментарий
                </button>
            </form>

            <div class="d-flex gap-2">
                <form asp-action="AcceptReport" method="post" class="mb-2">
                    <input type="hidden" name="deadlineId" id="deadlineId" value="@Model.DeadlineId" />
                    <input type="hidden" name="reportId" id="reportId" value="@Model.ReportId" />
                    <button type="submit" class="btn btn-success">
                        Принять отчет
                    </button>
                </form>
            </div>
        </div>
    }
    @try{
        <ul class="nav nav-tabs" id="branchTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-@Model.BranchName" data-bs-toggle="tab" data-bs-target="#branch-@Model.BranchName"
                        type="button" role="tab" aria-controls="branch-@Model.BranchName">
                    Филиал @Model.BranchName
                </button>
            </li>
        </ul>

        <div class="tab-content mt-3" id="branchTabsContent">
            @foreach (var branch in Model.ExcelData.Keys.Distinct())
            {
                <div class="tab-pane fade show active" id="branch-@branch" role="tabpanel" aria-labelledby="tab-@branch">
                    @{
                        var sheets = Model.ExcelData[branch].ToList();
                    }
                    @for (int i = 0; i < sheets.Count; i++)
                    {
                        var sheet = sheets[i];
                        <div class="sheet-container mb-4" data-sheet-index="@i" style="display:@(i == 0 ? "block" : "none")">
                            <div class="sheet-navigation">
                                <div class="nav-arrow prev-sheet" style="@(i == 0 ? "visibility:hidden" : "")">❮</div>
                                <div class="sheet-title">Лист: @sheet.Key</div>
                                <div class="nav-arrow next-sheet" style="@(i == sheets.Count - 1 ? "visibility:hidden" : "")">❯</div>
                            </div>
                            <div class="scrollable-table">
                                <div class="table-scroll-controls">
                                    <button class="scroll-btn scroll-left">❮</button>
                                    <button class="scroll-btn scroll-right">❯</button>
                                </div>
                                <table class="excel-table">
                                    @{
                                        var isHeader = true;
                                    }
                                    @foreach (var row in sheet.Value)
                                    {
                                        <tr>
                                            @foreach (var cell in row)
                                            {
                                                if (isHeader)
                                                {
                                                    <th>@cell</th>
                                                }
                                                else
                                                {
                                                    <td>@cell</td>
                                                }
                                            }
                                        </tr>
                                        isHeader = false;
                                    }
                                </table>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
        }
    catch{
        <div class="no-data">
            <i class="bi bi-file-excel" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">Нет данных для отображения</h4>
            <p>Отчет не содержит данных или у вас нет доступа к просмотру.</p>
        </div>
    }
    
</div>

@section Scripts {
    <script src="~/js/previewScript.js"> </script>
}